name: deployint to ec2 machine 
on : 
  push :
    branches : 
      - main

jobs : 
    build-backend:
      runs-on : ubuntu-latest
      steps : 
        - uses : actions/checkout@v4
          with:
            fetch-depth : 0
        
        - name: Docker login
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name : Build and push Docker image 
          uses : docker/build-push-action@v4
          with :
            context : .
            file : ./docker/dockerfile.backend
            push : true
            tags : bideshmukhi/backend:${{ github.sha }}
        - run : |
              echo "Deploying backend to ec2 machine"
              echo "${{ secrets.   }}" &> ~/ssh_key
              chmod 700 ~/ssh_key
              ssh -o StrictHostKeyChecking=no -i ~/ssh_key ubuntu@ec2-3-88-36-148.compute-1.amazonaws.com  "docker stop backend && docker run --name backend -d -p 3000:3000 XA12papa/backend:${{ github.sha }}"
